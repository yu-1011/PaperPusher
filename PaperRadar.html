<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç ”æ–‡ç« è‡ªåŠ¨æ¨é€æœºå™¨äºº (Slack)</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å¼ºåˆ¶ Inter å­—ä½“ */
        :root {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-2xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            ğŸ§¬ ç§‘ç ”æ–‡ç«  Slack æ¨é€æœºå™¨äºº
        </h1>
        <p class="text-gray-600 mb-8">
            é…ç½®æ‚¨çš„å…³é”®è¯å’Œ Slack Webhook URLï¼Œå³å¯ä¸€é”®æœç´¢å¹¶æ¨é€è¿‘æœŸçš„ç›¸å…³æ–‡ç« ã€‚
        </p>

        <!-- é…ç½®åŒºåŸŸ -->
        <div class="space-y-6">
            <!-- å…³é”®è¯è¾“å…¥ -->
            <div>
                <label for="keywords" class="block text-sm font-medium text-gray-700 mb-1">
                    è‡ªå®šä¹‰å…³é”®è¯ (Keywords)
                </label>
                <input type="text" id="keywords" value="CRISPR, Alzheimer, Genomics"
                       placeholder="ä¾‹å¦‚: gene editing, cancer, evolution"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                <p class="mt-1 text-xs text-gray-500">
                    è¯·ä½¿ç”¨é€—å·åˆ†éš”å¤šä¸ªå…³é”®è¯ã€‚æˆ‘ä»¬å·²é‡‡ç”¨æœ€å®½æ¾çš„æœç´¢é€»è¾‘ã€‚
                </p>
            </div>
            
            <!-- è‡ªå®šä¹‰æœŸåˆŠåˆ—è¡¨è¾“å…¥ -->
            <div>
                <label for="customJournals" class="block text-sm font-medium text-gray-700 mb-1">
                    è‡ªå®šä¹‰æœŸåˆŠåˆ—è¡¨ (Journals)
                </label>
                <input type="text" id="customJournals" 
                       value="Nature, Science, Cell, Nature Genetics, Cell Genomics, AJHG"
                       placeholder="ä¾‹å¦‚: New England Journal of Medicine, The Lancet, PNAS"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                <p class="mt-1 text-xs text-gray-500">
                    è¯·ä½¿ç”¨é€—å·åˆ†éš”å¤šä¸ªæœŸåˆŠåç§°ã€‚æ³¨æ„ä½¿ç”¨ Europe PMC / PubMed å¯è¯†åˆ«çš„åç§° (ä¾‹å¦‚ AJHG ä»£æ›¿ American Journal of Human Genetics)ã€‚
                </p>
            </div>

            <!-- æœç´¢å‚æ•°é…ç½® -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
                <div>
                    <label for="timeframe" class="block text-sm font-medium text-gray-700 mb-1">
                        æœç´¢æ—¶é—´èŒƒå›´ (Timeframe)
                    </label>
                    <select id="timeframe"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                        <option value="7">è¿‡å» 7 å¤© (é»˜è®¤)</option>
                        <option value="30">è¿‡å» 30 å¤©</option>
                        <option value="365">è¿‡å» 1 å¹´</option>
                        <option value="0">æ‰€æœ‰æ—¶é—´ (All Time) - ç”¨äºæµ‹è¯•</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">
                        é€‰æ‹©æ–‡ç« å‘è¡¨çš„æ—¶é—´èŒƒå›´ã€‚ç°åœ¨ä½¿ç”¨ FIRST_PDATE æ˜¾å¼æ—¥æœŸèŒƒå›´è¿‡æ»¤ã€‚
                    </p>
                </div>

                <!-- æ¯é¡µç»“æœæ•°é‡ -->
                <div>
                    <label for="pageSize" class="block text-sm font-medium text-gray-700 mb-1">
                        æ¯é¡µç»“æœæ•° (Max Results)
                    </label>
                    <input type="number" id="pageSize" value="50" min="1" max="1000"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                    <p class="mt-1 text-xs text-gray-500">
                        æ¯æ¬¡ API è°ƒç”¨æœ€å¤šè¿”å›çš„æ–‡ç« æ•°é‡ (Europe PMC é™åˆ¶æœ€å¤§ä¸º 1000)ã€‚
                    </p>
                </div>
            </div>

            <!-- Slack Webhook URL è¾“å…¥ -->
            <div>
                <label for="slackWebhookUrl" class="block text-sm font-medium text-gray-700 mb-1">
                    Slack Webhook URL
                </label>
                <input type="url" id="slackWebhookUrl"
                       placeholder="ç²˜è´´æ‚¨çš„ Slack Incoming Webhook URL"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                <p class="mt-1 text-xs text-red-500">
                    æ³¨æ„ï¼šæ‚¨éœ€è¦å…ˆåœ¨ Slack ä¸­è®¾ç½® Incoming Webhook ä»¥è·å–æ­¤ URLã€‚
                </p>
            </div>
        </div>

        <!-- è¿è¡ŒæŒ‰é’® -->
        <button id="runButton" onclick="runBot()"
                class="w-full mt-8 flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" id="loadingIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="buttonText">ğŸ¤– è¿è¡Œè‡ªåŠ¨æ¨é€</span>
        </button>

        <!-- ç»“æœ/æ¶ˆæ¯åŒºåŸŸ -->
        <div id="statusMessage" class="mt-6 p-4 rounded-lg text-center hidden"></div>
        
        <!-- æ–‡ç« åˆ—è¡¨æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="articleResultsContainer" class="mt-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">ğŸ” æ‰¾åˆ°çš„æ–‡ç« åˆ—è¡¨</h2>
            <div id="articleResults" class="space-y-4">
                <!-- æ–‡ç« åˆ—è¡¨å°†æ¸²æŸ“åœ¨è¿™é‡Œ -->
            </div>
        </div>

        <!-- æœç´¢æ—¥å¿— -->
        <div class="mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">æœç´¢è¯¦æƒ…ä¸æ—¥å¿—</h2>
            <pre id="logArea" class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto text-sm h-64 border border-gray-700"></pre>
        </div>
    </div>

    <script>
        // EUROPE_PMC_API ä¿æŒä¸å˜
        const EUROPE_PMC_API = 'https://www.ebi.ac.uk/europepmc/webservices/rest/search';
        
        const statusMessage = document.getElementById('statusMessage');
        const logArea = document.getElementById('logArea');
        const runButton = document.getElementById('runButton');
        const loadingIcon = document.getElementById('loadingIcon');
        const buttonText = document.getElementById('buttonText');
        const articleResults = document.getElementById('articleResults');
        const articleResultsContainer = document.getElementById('articleResultsContainer');
        // æ–°å¢æœŸåˆŠè¾“å…¥æ¡†çš„å¼•ç”¨
        const customJournalsInput = document.getElementById('customJournals');

        /**
         * è¾…åŠ©å‡½æ•°ï¼šè·å– N å¤©å‰çš„æ—¥æœŸï¼Œå¹¶æ ¼å¼åŒ–ä¸º YYYY-MM-DD
         * @param {number} daysAgo - å¤šå°‘å¤©å‰ (0 ä»£è¡¨ä»Šå¤©)
         * @returns {string} æ ¼å¼åŒ–åçš„æ—¥æœŸå­—ç¬¦ä¸²
         */
        function getDateNDaysAgo(daysAgo) {
            const date = new Date();
            date.setDate(date.getDate() - daysAgo);

            const year = date.getFullYear();
            // æœˆä»½æ˜¯ä» 0 å¼€å§‹çš„ï¼Œæ‰€ä»¥è¦ +1
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');

            // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä»£æ›¿æ¨¡æ¿å­—ç¬¦ä¸²ï¼Œç¡®ä¿å…¼å®¹æ€§
            return year + '-' + month + '-' + day;
        }
        
        /**
         * æ—¥å¿—è®°å½•å‡½æ•°
         * @param {string} message è¦è®°å½•çš„æ¶ˆæ¯
         * @param {string} type æ¶ˆæ¯ç±»å‹ ('info', 'error', 'success', 'warn')
         */
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            let color = 'text-green-400';
            if (type === 'error') color = 'text-red-400';
            if (type === 'warn') color = 'text-yellow-400';
            
            const logEntry = document.createElement('div');
            logEntry.className = color;
            // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä»£æ›¿æ¨¡æ¿å­—ç¬¦ä¸²
            logEntry.textContent = '[' + now + '] [' + type.toUpperCase() + '] ' + message;
            
            // ç¡®ä¿æ—¥å¿—åªä¿ç•™æœ€è¿‘çš„ 50 æ¡ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º
            while (logArea.children.length > 50) {
                logArea.removeChild(logArea.lastChild);
            }
            logArea.prepend(logEntry); // æœ€æ–°æ—¥å¿—åœ¨æœ€ä¸Šé¢
        }

        /**
         * æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
         * @param {string} message æ¶ˆæ¯å†…å®¹
         * @param {string} color é¢œè‰²ç±»å
         */
        function showStatus(message, color) {
            statusMessage.textContent = message;
            // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä»£æ›¿æ¨¡æ¿å­—ç¬¦ä¸²
            statusMessage.className = 'mt-6 p-4 rounded-lg text-center ' + color;
            statusMessage.style.display = 'block';
        }

        /**
         * å¯åŠ¨åŠ è½½çŠ¶æ€
         */
        function startLoading() {
            runButton.disabled = true;
            loadingIcon.classList.remove('hidden');
            buttonText.textContent = 'æ­£åœ¨è¿è¡Œä¸­...';
            logArea.innerHTML = '';
            articleResults.innerHTML = ''; // æ¸…ç©ºç»“æœ
            articleResultsContainer.classList.add('hidden'); // éšè—ç»“æœå®¹å™¨
            statusMessage.style.display = 'none';
        }

        /**
         * åœæ­¢åŠ è½½çŠ¶æ€
         */
        function stopLoading() {
            runButton.disabled = false;
            loadingIcon.classList.add('hidden');
            buttonText.textContent = 'ğŸ¤– è¿è¡Œè‡ªåŠ¨æ¨é€';
        }
        
        /**
         * åœ¨ UI ä¸Šæ˜¾ç¤ºæ‰¾åˆ°çš„æ–‡ç« åˆ—è¡¨
         * @param {Array<Object>} articles æ‰¾åˆ°çš„æ–‡ç« å¯¹è±¡æ•°ç»„
         */
        function displayArticleResults(articles) {
            articleResults.innerHTML = '';
            
            if (articles.length === 0) {
                articleResultsContainer.classList.add('hidden');
                return;
            }

            articleResultsContainer.classList.remove('hidden');

            // ç¡®ä¿æ–‡ç« ä¸é‡å¤
            const uniqueArticles = Array.from(new Set(articles.map(a => a.pmid)))
                                        .map(pmid => articles.find(a => a.pmid === pmid));

            uniqueArticles.forEach((article, index) => {
                const authors = article.authorList ? article.authorList.author.map(a => a.lastName).join(', ') : 'N/A';
                const journal = article.journalInfo?.journal?.title || 'æœªçŸ¥æœŸåˆŠ';
                const pubDate = article.journalInfo?.printPublicationDate || article.pubYear || 'N/A';
                const title = article.title;
                const doi = article.doi;
                const link = doi ? 'https://doi.org/' + doi : article.fullTextUrlList?.fullTextUrl?.[0]?.url || 'https://europepmc.org/article/MED/' + article.pmid;
                
                const articleDiv = document.createElement('div');
                articleDiv.className = 'p-4 border border-gray-200 rounded-lg bg-gray-50 hover:bg-gray-100 transition duration-150 shadow-sm';
                
                // æ ‡é¢˜å’Œé“¾æ¥
                const titleLink = document.createElement('a');
                titleLink.href = link;
                titleLink.target = '_blank';
                titleLink.className = 'text-lg font-medium text-indigo-600 hover:text-indigo-800 break-words';
                titleLink.textContent = title;
                
                // å…ƒä¿¡æ¯
                const metaP = document.createElement('p');
                metaP.className = 'text-sm text-gray-500 mt-1';
                metaP.innerHTML = '<strong>æœŸåˆŠ:</strong> ' + journal + ' | <strong>ä½œè€…:</strong> ' + authors + ' | <strong>å‘è¡¨äº:</strong> ' + pubDate;
                
                articleDiv.appendChild(titleLink);
                articleDiv.appendChild(metaP);
                
                articleResults.appendChild(articleDiv);
            });
        }

        /**
         * æ ¼å¼åŒ–æ–‡ç« åˆ—è¡¨ä¸º Slack æ¶ˆæ¯å†…å®¹
         * @param {Array<Object>} articles å·´
         * @param {number} daysAgo æœç´¢çš„å¤©æ•°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
         * @returns {Object} Slack Message Payload
         */
        function formatSlackMessage(articles, daysAgo) {
            let timeDesc;
            if (daysAgo === 0) {
                timeDesc = "æ‰€æœ‰æ—¶é—´";
            } else if (daysAgo === 7) {
                timeDesc = "ä¸Šå‘¨ï¼ˆæœ€è¿‘ 7 å¤©ï¼‰";
            } else if (daysAgo === 30) {
                timeDesc = "æœ€è¿‘ 30 å¤©";
            } else if (daysAgo === 365) {
                timeDesc = "æœ€è¿‘ 1 å¹´";
            } else {
                timeDesc = "é€‰å®šæ—¶é—´èŒƒå›´";
            }

            if (articles.length === 0) {
                return {
                    // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä»£æ›¿æ¨¡æ¿å­—ç¬¦ä¸²
                    text: 'ğŸ¤– *ç§‘ç ”æ–‡ç« æ¨é€æŠ¥å‘Š*ï¼šæœªæ‰¾åˆ°åœ¨ ' + timeDesc + ' å†…å‘è¡¨çš„ã€ä¸å…³é”®è¯åŒ¹é…çš„æ–‡ç« ã€‚',
                    blocks: [{
                        type: "section",
                        text: {
                            type: "mrkdwn",
                            text: ':wave: *ç§‘ç ”æ–‡ç« æ¨é€æŠ¥å‘Š*ï¼šæœªæ‰¾åˆ°åœ¨ ' + timeDesc + ' å†…å‘è¡¨çš„ã€ä¸å…³é”®è¯åŒ¹é…çš„æ–‡ç« ã€‚'
                        }
                    }]
                };
            }

            const header = {
                type: "header",
                text: {
                    type: "plain_text",
                    // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä»£æ›¿æ¨¡æ¿å­—ç¬¦ä¸²
                    text: 'ğŸ§¬ ' + timeDesc + ' ç§‘ç ”å¿«è®¯ (' + articles.length + ' ç¯‡)'
                }
            };

            const divider = {
                type: "divider"
            };

            const blocks = [header, divider];
            
            // ç¡®ä¿æ–‡ç« ä¸é‡å¤
            const uniqueArticles = Array.from(new Set(articles.map(a => a.pmid)))
                                        .map(pmid => articles.find(a => a.pmid === pmid));

            uniqueArticles.forEach((article, index) => {
                const authors = article.authorList ? article.authorList.author.map(a => a.lastName).join(', ') : 'N/A';
                const journal = article.journalInfo?.journal?.title || 'æœªçŸ¥æœŸåˆŠ';
                const pubDate = article.journalInfo?.printPublicationDate || article.pubYear || 'N/A';
                const title = article.title;
                const doi = article.doi;
                const link = doi ? 'https://doi.org/' + doi : article.fullTextUrlList?.fullTextUrl?.[0]?.url || 'https://europepmc.org/article/MED/' + article.pmid;

                const block = {
                    type: "section",
                    text: {
                        type: "mrkdwn",
                        // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä»£æ›¿æ¨¡æ¿å­—ç¬¦ä¸²
                        text: '*<' + link + '|' + title + '>*' + '\n' +
                              ':memo: ' + authors + '\n' +
                              ':mag: _' + journal + '_, ' + pubDate
                    },
                    accessory: {
                        type: "button",
                        text: {
                            type: "plain_text",
                            text: "æŸ¥çœ‹å…¨æ–‡",
                            emoji: true
                        },
                        url: link,
                        action_id: 'view_article_' + index
                    }
                };
                blocks.push(block);
            });

            return { blocks: blocks };
        }

        /**
         * ä» Europe PMC æœç´¢æ–‡ç« 
         * @param {string[]} journals æœŸåˆŠåç§°æ•°ç»„
         * @param {string[]} keywords å…³é”®è¯æ•°ç»„
         * @param {number} daysAgo æœç´¢çš„å¤©æ•° (0 ä»£è¡¨æ‰€æœ‰æ—¶é—´)
         * @param {number} pageSize æ¯é¡µç»“æœæ•°
         * @returns {Promise<Array<Object>>} æ–‡ç« å¯¹è±¡æ•°ç»„
         */
        async function fetchArticles(journals, keywords, daysAgo, pageSize) {
            if (keywords.length === 0 || journals.length === 0) return [];
            
            // æ„å»ºæœŸåˆŠæœç´¢éƒ¨åˆ†
            const journalQuery = journals.map(j => 'JOURNAL:"' + j + '"').join(' OR ');
            
            // å…³é”®è¯æŸ¥è¯¢ï¼šä½¿ç”¨æœ€å®½æ¾çš„åŒ¹é…
            const keywordQuery = keywords.join(' OR ');
            
            let timeQuery = '';
            let dateRangeDesc = 'æ‰€æœ‰æ—¶é—´';

            if (daysAgo > 0) {
                // *** æˆåŠŸçš„æ—¥æœŸä¿®å¤ï¼šä½¿ç”¨ FIRST_PDATE å­—æ®µå’Œ YYYY-MM-DD TO YYYY-MM-DD æ ¼å¼ ***
                const startDate = getDateNDaysAgo(daysAgo);
                const endDate = getDateNDaysAgo(0); // ä»Šå¤©
                
                timeQuery = ' AND (FIRST_PDATE:[' + startDate + ' TO ' + endDate + '])'; 
                dateRangeDesc = 'è‡ª ' + startDate + ' è‡³ ' + endDate;
            }

            // ç»¼åˆæŸ¥è¯¢ï¼š(æœŸåˆŠ) AND (å…³é”®è¯) [ AND (æ—¶é—´èŒƒå›´) ]
            // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä»£æ›¿æ¨¡æ¿å­—ç¬¦ä¸²
            const fullQuery = '(' + journalQuery + ') AND (' + keywordQuery + ')' + timeQuery;
            
            log('Europe PMC æœç´¢æŸ¥è¯¢: ' + fullQuery, 'info');
            log('æ—¥æœŸèŒƒå›´ï¼š' + dateRangeDesc, 'info');

            // ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä»£æ›¿æ¨¡æ¿å­—ç¬¦ä¸²
            const url = EUROPE_PMC_API + '?query=' + encodeURIComponent(fullQuery) + '&resultType=core&format=json&pageSize=' + pageSize;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('API è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ' + response.status);
                }
                const data = await response.json();
                
                const articles = data.resultList?.result || [];
                log('æˆåŠŸæ£€ç´¢åˆ° ' + articles.length + ' ç¯‡æ½œåœ¨æ–‡ç« ã€‚', 'success');
                return articles;
            } catch (error) {
                log('Europe PMC API è°ƒç”¨å¤±è´¥: ' + error.message, 'error');
                showStatus('API é”™è¯¯: ' + error.message, 'bg-red-100 text-red-800');
                return [];
            }
        }

        /**
         * æ¨é€æ¶ˆæ¯åˆ° Slack Webhook
         * @param {Object} payload Slack æ¶ˆæ¯ä½“
         * @param {string} webhookUrl Slack Webhook URL
         * @returns {Promise<boolean>} æ˜¯å¦æˆåŠŸ
         */
        async function postToSlack(payload, webhookUrl) {
            log('æ­£åœ¨å°è¯•å‘é€ Slack æ¶ˆæ¯...', 'info');
            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    // *** å…³é”®ä¿®å¤ï¼šå°† Content-Type è®¾ç½®ä¸º text/plainï¼Œä»¥é¿å… CORS é¢„æ£€ ***
                    headers: { 'Content-Type': 'text/plain' }, 
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    log('Slack æ¶ˆæ¯å‘é€æˆåŠŸï¼', 'success');
                    return true;
                } else {
                    const errorText = await response.text();
                    throw new Error('Slack Webhook è¿”å›é”™è¯¯çŠ¶æ€: ' + response.status + '. è¯¦æƒ…: ' + errorText);
                }
            } catch (error) {
                log('Slack æ¨é€å¤±è´¥: ' + error.message, 'error');
                return false;
            }
        }

        /**
         * æœºå™¨äººä¸»è¿è¡Œå‡½æ•°
         */
        async function runBot() {
            startLoading();
            
            const keywordsInput = document.getElementById('keywords').value.trim();
            const journalsInput = customJournalsInput.value.trim(); // è¯»å–æ–°çš„æœŸåˆŠè¾“å…¥æ¡†
            const webhookUrl = document.getElementById('slackWebhookUrl').value.trim();
            // timeframe çš„å€¼ç°åœ¨æ˜¯å¤©æ•° (7, 30, 365) æˆ– 0 (æ‰€æœ‰æ—¶é—´)
            const daysAgo = parseInt(document.getElementById('timeframe').value, 10); 
            const pageSize = parseInt(document.getElementById('pageSize').value, 10);
            
            // 1. éªŒè¯è¾“å…¥
            if (!keywordsInput || !journalsInput) {
                log('é”™è¯¯ï¼šå…³é”®è¯å’ŒæœŸåˆŠåˆ—è¡¨éƒ½ä¸èƒ½ä¸ºç©ºã€‚', 'error');
                showStatus('æ“ä½œå¤±è´¥ï¼šè¯·è¾“å…¥å…³é”®è¯å’ŒæœŸåˆŠåˆ—è¡¨ã€‚', 'bg-red-100 text-red-800');
                stopLoading();
                return;
            }

            const keywords = keywordsInput.split(',').map(k => k.trim()).filter(k => k.length > 0);
            const journals = journalsInput.split(',').map(j => j.trim()).filter(j => j.length > 0);
            
            if (keywords.length === 0 || journals.length === 0) {
                log('é”™è¯¯ï¼šå…³é”®è¯æˆ–æœŸåˆŠåˆ—è¡¨è§£æåä¸ºç©ºã€‚', 'error');
                showStatus('æ“ä½œå¤±è´¥ï¼šè¯·æ£€æŸ¥å…³é”®è¯å’ŒæœŸåˆŠåˆ—è¡¨æ˜¯å¦æœ‰æ•ˆã€‚', 'bg-red-100 text-red-800');
                stopLoading();
                return;
            }

            // æ£€æŸ¥ timeTag çš„æè¿°
            let timeDescLog = 'æ‰€æœ‰æ—¶é—´';
            if (daysAgo > 0) {
                const startDate = getDateNDaysAgo(daysAgo);
                const endDate = getDateNDaysAgo(0);
                timeDescLog = 'æ˜¾å¼èŒƒå›´: ' + startDate + ' è‡³ ' + endDate;
            }

            log('å·²è§£æå…³é”®è¯: ' + keywords.join(', '), 'info');
            log('ç›®æ ‡æœŸåˆŠ: ' + journals.join(', '), 'info'); // ä½¿ç”¨è§£æåçš„æœŸåˆŠåˆ—è¡¨
            log('æœç´¢èŒƒå›´: ' + timeDescLog, 'info');
            log('æ¯é¡µæœ€å¤§ç»“æœæ•°: ' + pageSize, 'info');

            // 2. æœç´¢æ–‡ç« 
            const articles = await fetchArticles(journals, keywords, daysAgo, pageSize); // ä¼ å…¥æœŸåˆŠåˆ—è¡¨

            // 3. æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨
            displayArticleResults(articles);

            // 4. æ ¼å¼åŒ– Slack æ¶ˆæ¯ä½“
            const slackPayload = formatSlackMessage(articles, daysAgo);

            // 5. æ¨é€åˆ° Slack (ä»…å½“ Webhook URL æœ‰æ•ˆæ—¶)
            let success = false;
            if (webhookUrl && webhookUrl.startsWith('http')) {
                success = await postToSlack(slackPayload, webhookUrl);
            } else {
                log('è­¦å‘Šï¼šSlack Webhook URL ä¸ºç©ºæˆ–æ— æ•ˆï¼Œè·³è¿‡æ¨é€æ­¥éª¤ã€‚è¯·åœ¨æ—¥å¿—ä¸­æŸ¥çœ‹æ–‡ç« æœç´¢ç»“æœã€‚', 'warn');
                success = true; // å³ä½¿æ²¡æœ‰æ¨é€ï¼Œæœç´¢æˆåŠŸä¹Ÿç®—æˆåŠŸ
            }


            // 6. æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
            if (success) {
                if (articles.length > 0) {
                    const pushStatus = webhookUrl && webhookUrl.startsWith('http') ? 'å¹¶å·²å‘é€è‡³æ‚¨çš„ Slack é¢‘é“ã€‚' : '(æœªæ¨é€åˆ° Slack)ã€‚';
                    showStatus('æœç´¢æˆåŠŸï¼å·²æ‰¾åˆ° ' + articles.length + ' ç¯‡ç›¸å…³æ–‡ç« ' + pushStatus, 'bg-green-100 text-green-800');
                } else {
                    const pushStatus = webhookUrl && webhookUrl.startsWith('http') ? 'å·²å‘é€ç©ºæŠ¥å‘Šåˆ° Slackã€‚' : '(æœªæ¨é€åˆ° Slack)ã€‚';
                    showStatus('æœç´¢æˆåŠŸï¼šæœªæ‰¾åˆ°ç›¸å…³æ–‡ç« ã€‚' + pushStatus, 'bg-yellow-100 text-yellow-800');
                }
            } else {
                showStatus('æ“ä½œå¤±è´¥ï¼šè¯·æ£€æŸ¥ Slack Webhook URL å’Œæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯ã€‚', 'bg-red-100 text-red-800');
            }
            
            stopLoading();
        }

        // é¦–æ¬¡åŠ è½½æ—¶è¿›è¡Œä¸€äº›åˆå§‹åŒ–æç¤º
        window.onload = () => {
             log('æœºå™¨äººå·²å‡†å¤‡å°±ç»ªã€‚è¯·é…ç½®å…³é”®è¯å’Œ Slack Webhook URLã€‚', 'info');
        }

    </script>
</body>
</html>